<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StampID - Create Permanent Proof</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        h1, h2 {
            text-align: center;
            color: #1a202c;
        }
        
        h1 {
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 30px;
            font-size: 1.2em;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
        }
        
        /* Sections */
        section {
            display: none; /* JS will manage visibility */
            margin-top: 20px;
        }

        /* Status Bar */
        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        .status.info { background-color: #e0f2fe; color: #0c54a8; }
        .status.success { background-color: #dcfce7; color: #166534; }
        .status.error { background-color: #fee2e2; color: #991b1b; }

        /* Form Elements */
        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px 15px;
            border-radius: 6px;
            border: none;
            color: white;
            background-color: #2563eb;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 10px;
        }

        button:hover {
            background-color: #1d4ed8;
        }
        
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        #signup-btn {
             background-color: #6b7280;
        }
        #signup-btn:hover {
             background-color: #4b5563;
        }

        #signout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: auto;
            padding: 8px 12px;
            font-size: 12px;
            background-color: #ef4444;
        }

        /* Drop Zone */
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            color: #666;
            transition: background-color 0.2s, border-color 0.2s;
        }
        #drop-zone.dragover {
            background-color: #e0f2fe;
            border-color: #2563eb;
        }
        #fileInput {
            display: none;
        }
        #file-info, #hash-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            margin-top: 15px;
            word-wrap: break-word;
        }
        
        /* Payment Element */
        #payment-element {
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        
        /* Results */
        #results-info a {
            color: #2563eb;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>StampID</h1>
        <div id="status" class="status info">Initializing...</div>

        <button id="signout-btn" style="display: none;">Sign Out</button>

        <section id="auth-section">
            <h2>Login or Sign Up</h2>
            <input type="email" id="email" placeholder="Enter your email" required>
            <input type="password" id="password" placeholder="Enter your password" required>
            <button id="login-btn">Login</button>
            <button id="signup-btn">Sign Up</button>
        </section>

        <section id="upload-section">
            <h2>1. Upload Your File</h2>
            <div id="drop-zone">
                <strong>Drag & Drop a file here</strong><br> or click to select a file
            </div>
            <input type="file" id="fileInput">
            <div id="file-info"></div>
            <div id="hash-info" style="display: none;"></div>
            <button id="reset-file-btn" style="display: none;">Choose a different file</button>
        </section>

        <section id="payment-section">
            <h2>2. Pay to Create Proof ($1.99)</h2>
            <div id="payment-element">
                </div>
            <button id="notarize-btn">Pay & Create Proof</button>
        </section>

        <section id="results-section">
            <h2>3. Your Proof is Ready</h2>
            <div id="results-info">
                </div>
        </section>

    </div>

    <script>
        // =================================================================================
        // 1. CONFIGURATION & INITIALIZATION
        // =================================================================================
        const BACKEND_URL = "http://localhost:3000";
        const SUPABASE_URL = "https://mfrefbmnxygeahaluhzr.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcmVmYm1ueHlnZWFoYWx1aHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NDIxOTUsImV4cCI6MjA2ODExODE5NX0.Ur3hl7rVEWk6U-ydNbKymFmXtxUlx6RTn0pU0EnP7u0";

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let stripe, cardElement;

        // =================================================================================
        // 2. DOM ELEMENT REFERENCES
        // =================================================================================
        const statusElement = document.getElementById('status');
        const authSection = document.getElementById('auth-section');
        const uploadSection = document.getElementById('upload-section');
        const paymentSection = document.getElementById('payment-section');
        const resultsSection = document.getElementById('results-section');

        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('drop-zone');
        const fileInfoDiv = document.getElementById('file-info');
        const hashInfoDiv = document.getElementById('hash-info');
        const paymentElementContainer = document.getElementById('payment-element');
        const resultsInfoDiv = document.getElementById('results-info');

        const notarizeBtn = document.getElementById('notarize-btn');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const resetFileBtn = document.getElementById('reset-file-btn');

        // =================================================================================
        // 3. APPLICATION STATE
        // =================================================================================
        let appState = {
        user: null,
        uploadedFile: null,
        fileHash: null,
        isBusy: false,
        };

        // =================================================================================
        // 4. UI MANAGEMENT
        // =================================================================================

        /** Displays a status message to the user. */
        function setStatus(message, type = 'info') {
        statusElement.textContent = message;
        statusElement.className = `status ${type}`;
        }

        /** Toggles a button's disabled state and text content. */
        function setButtonBusy(button, busy, text = 'Processing...') {
        if (!button) return;
        button.disabled = busy;
        if (busy) {
            button.dataset.originalText = button.textContent;
            button.textContent = text;
        } else {
            button.textContent = button.dataset.originalText || '';
        }
        }

        /** Updates the visibility of UI sections based on the application state. */
        function updateUIState() {
            const { user, uploadedFile, fileHash } = appState;
            
            authSection.style.display = user ? 'none' : 'block';
            signoutBtn.style.display = user ? 'block' : 'none';
            uploadSection.style.display = user ? 'block' : 'none';

            paymentSection.style.display = user && fileHash ? 'block' : 'none';
            
            // Always hide results until a notarization is complete
            if (resultsSection.style.display !== 'block') {
                 resultsSection.style.display = 'none';
            }

            if (uploadedFile) {
                fileInfoDiv.innerHTML = `<strong>File:</strong> ${uploadedFile.name} | <strong>Size:</strong> ${(uploadedFile.size / 1024 / 1024).toFixed(2)} MB`;
                hashInfoDiv.style.display = fileHash ? 'block' : 'none';
                if(fileHash) hashInfoDiv.textContent = `SHA-256 Hash: ${fileHash}`;
                dropZone.style.display = 'none';
                resetFileBtn.style.display = 'block';
            } else {
                fileInfoDiv.innerHTML = '';
                hashInfoDiv.style.display = 'none';
                dropZone.style.display = 'block';
                resetFileBtn.style.display = 'none';
            }
        }

        // =================================================================================
        // 5. AUTHENTICATION
        // =================================================================================

        /** Checks for an active Supabase session and updates the UI. */
        async function checkAuth() {
            const { data: { session } } = await sb.auth.getSession();
            appState.user = session ? session.user : null;
            if (appState.user) {
                setStatus(`Authenticated as ${appState.user.email}.`, 'success');
            } else {
                setStatus('Please log in or sign up to continue.', 'info');
            }
            updateUIState();
        }

        /** Handles user sign-in. */
        async function signInUser() {
            if (appState.isBusy) return;
            appState.isBusy = true;
            setButtonBusy(loginBtn, true, 'Signing In...');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const { error } = await sb.auth.signInWithPassword({ email, password });
                if (error) throw error;
                await checkAuth(); // Re-check auth state on success
            } catch (err) {
                handleApiError('Sign-in failed', err);
            } finally {
                appState.isBusy = false;
                setButtonBusy(loginBtn, false);
            }
        }

        /** Handles new user sign-up. */
        async function signUpUser() {
            if (appState.isBusy) return;
            appState.isBusy = true;
            setButtonBusy(signupBtn, true, 'Signing Up...');
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const { error } = await sb.auth.signUp({ email, password });
                if (error) throw error;
                setStatus('Sign-up successful! Please check your email for verification.', 'success');
            } catch (err) {
                handleApiError('Sign-up failed', err);
            } finally {
                appState.isBusy = false;
                setButtonBusy(signupBtn, false);
            }
        }

        /** Handles user sign-out. */
        async function signOutUser() {
            await sb.auth.signOut();
            appState.user = null;
            resetFileSelection(); // Also clear file state
            setStatus('You have been signed out.', 'info');
            updateUIState();
        }

        // =================================================================================
        // 6. FILE HANDLING
        // =================================================================================

        /** Resets the file input and application state. */
        function resetFileSelection() {
            appState.uploadedFile = null;
            appState.fileHash = null;
            fileInput.value = ''; // Clear the file input
            resultsSection.style.display = 'none'; // Hide old results
            updateUIState();
        }

        /** Processes the selected file and calculates its hash. */
        async function handleFile(file) {
            if (!file) return;
            resetFileSelection();
            appState.uploadedFile = file;
            updateUIState();
            
            setStatus('Generating cryptographic hash...', 'info');
            
            try {
                const buffer = await file.arrayBuffer();
                const digest = await crypto.subtle.digest('SHA-256', buffer);
                const hash = [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, '0')).join('');
                
                appState.fileHash = hash;
                setStatus('Hash generated. Ready for payment.', 'success');
                initializeStripe(); // Pre-load stripe now that we have a file
            } catch (err) {
                setStatus('Failed to generate file hash: ' + err.message, 'error');
            }
            updateUIState();
        }

        // =================================================================================
        // 7. PAYMENT & NOTARIZATION
        // =================================================================================

        /** Initializes the Stripe.js library and mounts the card element. */
        async function initializeStripe() {
            if (stripe) return; // Already initialized
            try {
                const response = await apiFetch('/config');
                const { stripePublicKey } = response;
                if (!stripePublicKey) throw new Error('stripePublicKey missing');

                stripe = Stripe(stripePublicKey);
                const elements = stripe.elements();
                cardElement = elements.create('card');
                cardElement.mount(paymentElementContainer);
            } catch (err) {
                handleApiError('Could not initialize payment system', err);
            }
        }

        /** Main function to process payment and trigger notarization. */
        async function processNotarization() {
            if (appState.isBusy || !appState.fileHash || !stripe || !cardElement) {
                setStatus('Please select a file and wait for systems to be ready.', 'info');
                return;
            }
            
            appState.isBusy = true;
            setButtonBusy(notarizeBtn, true);
            setStatus('Initiating payment...', 'info');
            
            try {
                const paymentData = await apiFetch('/create-payment', {
                    method: 'POST',
                    body: { document_hash: appState.fileHash }
                });
                if (!paymentData.clientSecret) throw new Error('clientSecret missing');

                const { paymentIntent, error: stripeError } = await stripe.confirmCardPayment(
                    paymentData.clientSecret, { payment_method: { card: cardElement } }
                );
                if (stripeError) throw new Error(stripeError.message);
                if (paymentIntent.status !== 'succeeded') throw new Error('Payment was not successful.');

                setStatus('Payment successful! Finalizing proof...', 'success');
                await notarizeDocument();
                
            } catch (err) {
                handleApiError('Notarization process failed', err);
            } finally {
                appState.isBusy = false;
                setButtonBusy(notarizeBtn, false);
            }
        }

        /** Sends the file to the backend for final notarization. */
        async function notarizeDocument() {
            const formData = new FormData();
            formData.append('document', appState.uploadedFile);
            formData.append('name', appState.uploadedFile.name);
            if (appState.user?.email) formData.append('email', appState.user.email);
            
            const result = await apiFetch('/notarize', { method: 'POST', body: formData, isJson: false });
            if (!result.success) throw new Error(result.details || 'Unknown notarization error');

            paymentSection.style.display = 'none'; // Hide payment form on success
            uploadSection.style.display = 'none'; // Hide upload form on success
            resultsSection.style.display = 'block';
            resultsInfoDiv.innerHTML = `
                <div class="status success">
                <p><strong>Proof Created Successfully!</strong></p>
                <p><strong>VeChain Transaction:</strong> <a href="${result.explorerUrl}" target="_blank" rel="noopener noreferrer">${result.vechainTx}</a></p>
                <p><strong>Document Hash:</strong> ${result.documentHash}</p>
                <p><strong>Document URL:</strong> <a href="${result.documentUrl}" target="_blank" rel="noopener noreferrer">View Stored File</a></p>
                </div>
            `;
            setStatus('Process complete!', 'success');
        }

        // =================================================================================
        // 8. UTILITIES & EVENT LISTENERS
        // =================================================================================

        /** A generic wrapper for fetch calls to the backend. */
        async function apiFetch(endpoint, options = {}) {
            const { method = 'GET', body = null, isJson = true } = options;
            const headers = {};
            let reqBody = body;

            if (isJson && body) {
                headers['Content-Type'] = 'application/json';
                reqBody = JSON.stringify(body);
            }

            const response = await fetch(`${BACKEND_URL}${endpoint}`, { method, headers, body: reqBody });

            if (!response.ok) {
                const errorText = await response.text().catch(() => '(Could not read error body)');
                throw new Error(`Request failed: ${response.status} ${response.statusText}. Details: ${errorText}`);
            }
            return response.json();
        }

        /** A generic error handler to log details and show a user-friendly message. */
        function handleApiError(userMessage, error) {
            console.error(`${userMessage}:`, error);
            setStatus(`${userMessage}. Please try again.`, 'error');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loginBtn?.addEventListener('click', signInUser);
            signupBtn?.addEventListener('click', signUpUser);
            signoutBtn?.addEventListener('click', signOutUser);

            dropZone?.addEventListener('click', () => fileInput.click());
            fileInput?.addEventListener('change', (e) => handleFile(e.target.files[0]));
            resetFileBtn?.addEventListener('click', resetFileSelection);

            dropZone?.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone?.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone?.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });

            notarizeBtn?.addEventListener('click', processNotarization);
            
            checkAuth(); // Initial check
        });

    </script>
</body>
</html>
