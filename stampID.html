<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StampID | Final User Test</title>

    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary-color: #2563eb; --primary-hover: #1d4ed8; --danger-color: #dc2626; --light-gray: #f4f7f9; --medium-gray: #e2e8f0; --dark-gray: #4b5563; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light-gray); color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .container { max-width: 600px; width: 100%; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); position: relative; }
        h1, h2 { text-align: center; color: #1a202c; }
        h1 { margin-bottom: 20px; }
        h2 { margin-top: 30px; font-size: 1.2em; border-bottom: 1px solid var(--medium-gray); padding-bottom: 10px; }
        section { display: none; margin-top: 20px; }
        .status { padding: 12px; border-radius: 6px; margin-bottom: 20px; font-weight: 500; text-align: center; transition: background-color 0.3s; }
        .status.info { background-color: #e0f2fe; color: #0c54a8; }
        .status.success { background-color: #dcfce7; color: #166534; }
        .status.error { background-color: #fee2e2; color: #991b1b; }
        input[type="email"], input[type="password"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px 15px; border-radius: 6px; border: none; color: white; background-color: var(--primary-color); font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; margin-top: 10px; }
        button:hover:not(:disabled) { background-color: var(--primary-hover); }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        #signup-btn { background-color: var(--dark-gray); }
        #signup-btn:hover:not(:disabled) { background-color: #334155; }
        #signout-btn { position: absolute; top: 20px; right: 20px; width: auto; background: none; color: var(--danger-color); font-size: 14px; padding: 5px; font-weight: normal; }
        #drop-zone { border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; color: #666; transition: background-color 0.2s, border-color 0.2s; }
        #drop-zone.dragover { background-color: #e0f2fe; border-color: var(--primary-color); }
        #fileInput { display: none; }
        #file-info, #hash-info { background: var(--light-gray); padding: 15px; border-radius: 6px; border: 1px solid var(--medium-gray); margin-top: 15px; }
        #hash-info { font-family: monospace; font-size: 12px; word-wrap: break-word; }
        #payment-element { padding: 15px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 15px; }
        #results-info a { color: var(--primary-color); font-weight: bold; text-decoration: none; }
        #results-info a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <h1>StampID</h1>
        <div id="status" class="status info">Initializing...</div>
        <button id="signout-btn" style="display: none;">Sign Out</button>

        <section id="auth-section">
            <h2>1. Sign In / Sign Up</h2>
            <input type="email" id="email" placeholder="Enter your email" required>
            <input type="password" id="password" placeholder="Enter your password" required>
            <button id="login-btn">Sign In</button>
            <button id="signup-btn">Sign Up</button>
        </section>

        <section id="upload-section">
            <h2>2. Upload Document</h2>
            <div id="drop-zone"><strong>Drag & Drop file here</strong><br> or click to select</div>
            <input type="file" id="fileInput">
            <div id="file-info"></div>
            <div id="hash-info" style="display: none;"></div>
        </section>

        <section id="payment-section">
            <h2>3. Create Proof ($1.99)</h2>
            <div id="payment-element"></div>
            <button id="notarize-btn">Pay & Notarize</button>
        </section>

        <section id="results-section">
            <h2>4. Your Proof Is Ready</h2>
            <div id="results-info"></div>
            <button id="start-over-btn">Notarize Another File</button>
        </section>
    </div>

<script>
// =================================================================================
// === CONFIGURATION ===
// =================================================================================
const CONFIG = {
    // ⚠️ ACTION REQUIRED: PASTE YOUR SUPABASE KEYS HERE
    SUPABASE_URL: 'YOUR_SUPABASE_URL',
    SUPABASE_ANON_KEY: 'YOUR_SUPABASE_ANON_KEY',
    
    // This should point to your running back-end server
    BACKEND_URL: "http://localhost:3000",
};
// =================================================================================

// === STATE ===
const state = {
    user: null,
    file: null,
    hash: null,
    isBusy: false,
    stripe: null,
    cardElement: null,
};

// === DOM ELEMENTS ===
const dom = {};
document.addEventListener('DOMContentLoaded', () => {
    const ids = ['status', 'signout-btn', 'auth-section', 'email', 'password', 'login-btn', 'signup-btn', 'upload-section', 'drop-zone', 'fileInput', 'file-info', 'hash-info', 'payment-section', 'payment-element', 'notarize-btn', 'results-section', 'results-info', 'start-over-btn'];
    ids.forEach(id => dom[id] = document.getElementById(id));
    
    initialize();
});

// === UI MANAGEMENT ===
function setStatus(message, type = 'info') {
    dom.status.textContent = message;
    dom.status.className = `status ${type}`;
}

function setBusy(busyState, button) {
    state.isBusy = busyState;
    if (button) {
        button.disabled = busyState;
        if (busyState) {
            button.dataset.originalText = button.textContent;
            button.textContent = 'Processing...';
        } else {
            button.textContent = button.dataset.originalText;
        }
    }
}

function updateUI() {
    const { user, file, hash } = state;
    dom['signout-btn'].style.display = user ? 'block' : 'none';
    
    const show = (section) => {
        ['auth-section', 'upload-section', 'payment-section', 'results-section'].forEach(s => dom[s].style.display = 'none');
        if (dom[section]) dom[section].style.display = 'block';
    };

    if (!user) return show('auth-section');
    if (user && !file) {
        // Reset file info for new uploads
        dom['file-info'].innerHTML = '';
        dom['hash-info'].style.display = 'none';
        return show('upload-section');
    }
    if (user && file && !hash) return show('upload-section'); // Hashing in progress
    if (user && file && hash) return show('payment-section');
}

// === ERROR HANDLING ===
function handleError(error, userMessage = 'An unexpected error occurred.') {
    console.error('[STAMPID_ERROR]', error);
    setStatus(userMessage, 'error');
    setBusy(false, document.querySelector('button:disabled')); // Re-enable any busy button
}

// === AUTHENTICATION ===
async function checkAuth() {
    const { data: { session } } = await sb.auth.getSession();
    state.user = session ? session.user : null;
    updateUI();
}

async function handleAuth(type) {
    if (state.isBusy) return;
    const button = (type === 'signin') ? dom['login-btn'] : dom['signup-btn'];
    setBusy(true, button);

    try {
        const email = dom.email.value;
        const password = dom.password.value;
        if (!email || !password) throw new Error('Email and password are required.');
        
        const method = type === 'signin' ? sb.auth.signInWithPassword : sb.auth.signUp;
        const { error } = await method({ email, password });
        if (error) throw error;
        
        setStatus('Authentication successful!', 'success');
        checkAuth();
    } catch (error) {
        handleError(error, error.message);
    } finally {
        setBusy(false, button);
    }
}

async function signOut() {
    await sb.auth.signOut();
    state.user = null;
    state.file = null;
    state.hash = null;
    setStatus('You have been signed out.', 'info');
    updateUI();
}

// === FILE & HASHING ===
async function handleFile(file) {
    if (!file) return;
    state.file = file;
    state.hash = null;
    dom['file-info'].innerHTML = `<strong>File:</strong> ${file.name} | <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB`;
    dom['hash-info'].style.display = 'none';
    setStatus('Generating cryptographic hash...', 'info');

    try {
        const buffer = await file.arrayBuffer();
        const digest = await crypto.subtle.digest('SHA-256', buffer);
        state.hash = Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
        
        dom['hash-info'].style.display = 'block';
        dom['hash-info'].textContent = `SHA-256: ${state.hash}`;
        setStatus('Hash generated. Ready for payment.', 'success');
        updateUI();
        initializeStripe();
    } catch (error) {
        handleError(error, 'Failed to generate file hash.');
    }
}

// === PAYMENT & NOTARIZATION ===
async function initializeStripe() {
    if (state.stripe) return;
    try {
        const res = await fetch(`${CONFIG.BACKEND_URL}/config`);
        const { stripePublicKey } = await res.json();
        state.stripe = Stripe(stripePublicKey);
        const elements = state.stripe.elements();
        state.cardElement = elements.create('card');
        state.cardElement.mount(dom['payment-element']);
    } catch (error) {
        handleError(error, 'Could not connect to payment system. Is the server running?');
    }
}

async function processNotarization() {
    if (state.isBusy || !state.stripe) return;
    setBusy(true, dom['notarize-btn']);

    try {
        // 1. Create Payment Intent from our backend
        setStatus('Contacting payment server...', 'info');
        const paymentRes = await fetch(`${CONFIG.BACKEND_URL}/create-payment`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ document_hash: state.hash })
        });
        const { clientSecret, error: intentError } = await paymentRes.json();
        if (intentError || !clientSecret) throw new Error(intentError || 'Failed to create payment intent.');

        // 2. Confirm card payment with Stripe
        setStatus('Please confirm payment...', 'info');
        const { paymentIntent, error: paymentError } = await state.stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: state.cardElement }
        });
        if (paymentError) throw new Error(paymentError.message);
        if (paymentIntent.status !== 'succeeded') throw new Error('Payment was not successful.');

        // 3. Send file to backend for notarization
        setStatus('Payment successful! Creating proof on VeChain...', 'success');
        const formData = new FormData();
        formData.append('document', state.file);
        formData.append('document_hash', state.hash);
        const notarizeRes = await fetch(`${CONFIG.BACKEND_URL}/notarize`, { method: 'POST', body: formData });
        const result = await notarizeRes.json();
        if (!result.success) throw new Error(result.details || 'Notarization failed on the server.');

        // 4. Display results (the "look up")
        dom['results-info'].innerHTML = `
            <div class="status success">
                <p><strong>✅ Proof Created Successfully!</strong></p>
                <p><strong>VeChain Transaction:</strong> <a href="${result.explorerUrl}" target="_blank" rel="noopener noreferrer">${result.vechainTx}</a></p>
                <p><strong>Block Number:</strong> ${result.blockNumber}</p>
                <p><strong>Document Hash:</strong> <code style="font-size:14px;">${result.documentHash}</code></p>
            </div>
        `;
        dom['payment-section'].style.display = 'none';
        dom['results-section'].style.display = 'block';
        setStatus('Process Complete!', 'success');

    } catch (error) {
        handleError(error, error.message);
    } finally {
        setBusy(false, dom['notarize-btn']);
    }
}

// === INITIALIZATION ===
function setupEventListeners() {
    dom['login-btn'].addEventListener('click', () => handleAuth('signin'));
    dom['signup-btn'].addEventListener('click', () => handleAuth('signup'));
    dom['signout-
