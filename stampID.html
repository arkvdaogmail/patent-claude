<script>
  const BACKEND_URL = "http://localhost:3000";
  const SUPABASE_URL = "https://mfrefbmnxygeahaluhzr.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcmVmYm1ueHlnZWFoYWx1aHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NDIxOTUsImV4cCI6MjA2ODExODE5NX0.Ur3hl7rVEWk6U-ydNbKymFmXtxUlx6RTn0pU0EnP7u0";

  // Optional: put your Stripe publishable key here to bypass /config while testing
  const MANUAL_STRIPE_KEY = ""; // e.g. "pk_test_123..." or leave "" to use /config

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let stripe, elements, cardElement;

  const statusElement = document.getElementById('status');
  const authSection = document.getElementById('auth-section');
  const uploadSection = document.getElementById('upload-section');
  const paymentSection = document.getElementById('payment-section');
  const paymentElementContainer = document.getElementById('payment-element');
  const notarizeBtn = document.getElementById('notarize-btn');
  const fileInput = document.getElementById('fileInput');
  const dropZone = document.getElementById('drop-zone');
  const fileInfoDiv = document.getElementById('file-info');
  const hashInfoDiv = document.getElementById('hash-info');
  const resultsSection = document.getElementById('results-section');
  const resultsInfoDiv = document.getElementById('results-info');

  let uploadedFile = null;
  let fileHash = null;

  function setStatus(message, type) {
    statusElement.textContent = `Status: ${message}`;
    statusElement.className = `status ${type}`;
  }

  async function checkAuth() {
    const { data: { user } } = await sb.auth.getUser();
    if (user) {
      setStatus('Authenticated. You can upload files now.', 'success');
      authSection.style.display = 'none';
      uploadSection.style.display = 'block';
    } else {
      setStatus('Please log in to continue.', 'info');
    }
  }

  async function loginUser() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    try {
      let { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        const { data: signUpData, error: signUpError } = await sb.auth.signUp({ email, password });
        if (signUpError) throw signUpError;
        data = signUpData;
      }
      setStatus(`Logged in as ${data.user.email}.`, 'success');
      checkAuth();
    } catch (err) {
      setStatus('Authentication failed: ' + err.message, 'error');
    }
  }
  window.loginUser = loginUser;

  dropZone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

  function handleFile(file) {
    if (!file) return;
    uploadedFile = file;
    fileInfoDiv.innerHTML = `<strong>File:</strong> ${file.name} | <strong>Size:</strong> ${(file.size/1024/1024).toFixed(2)} MB`;
    setStatus('Generating cryptographic hash...', 'info');
    notarizeBtn.disabled = true;

    getFileHash(uploadedFile).then(hash => {
      fileHash = hash;
      hashInfoDiv.style.display = 'block';
      hashInfoDiv.textContent = `SHA-256 Hash: ${hash}`;
      setStatus('Hash generated successfully.', 'success');
      paymentSection.style.display = 'block';
      notarizeBtn.disabled = false;
    }).catch(err => setStatus('Failed to generate hash: ' + err.message, 'error'));
  }

  async function getFileHash(file) {
    const buffer = await file.arrayBuffer();
    const digest = await crypto.subtle.digest('SHA-256', buffer);
    return [...new Uint8Array(digest)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  async function ensureStripeReady() {
    if (stripe) return; // already ready

    if (MANUAL_STRIPE_KEY) {
      stripe = Stripe(MANUAL_STRIPE_KEY);
      elements = stripe.elements();
      cardElement = elements.create('card');
      cardElement.mount(paymentElementContainer);
      return;
    }

    // Try fetching from back-end /config with detailed error report
    try {
      const res = await fetch(`${BACKEND_URL}/config`);
      if (!res.ok) {
        const body = await res.text().catch(()=>'(no body)');
        throw new Error(`GET /config ${res.status} ${res.statusText}. Body: ${body}`);
      }
      const cfg = await res.json();
      if (!cfg.stripePublicKey) throw new Error('stripePublicKey missing in /config response');
      stripe = Stripe(cfg.stripePublicKey);
      elements = stripe.elements();
      cardElement = elements.create('card');
      cardElement.mount(paymentElementContainer);
    } catch (err) {
      console.error('Stripe config error:', err);
      setStatus('Failed to fetch Stripe config. ' + err.message, 'error');
      throw err; // propagate so payment step halts
    }
  }

  notarizeBtn.addEventListener('click', async () => {
    if (!uploadedFile || !fileHash) {
      setStatus('Please upload and hash a file first.', 'info');
      return;
    }

    try {
      await ensureStripeReady();
    } catch {
      return; // status already shown
    }

    setStatus('Initiating payment...', 'info');
    notarizeBtn.disabled = true;

    try {
      const resp = await fetch(`${BACKEND_URL}/create-payment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ document_hash: fileHash })
      });
      if (!resp.ok) {
        const body = await resp.text().catch(()=>'(no body)');
        throw new Error(`POST /create-payment ${resp.status} ${resp.statusText}. Body: ${body}`);
      }
      const { clientSecret } = await resp.json();
      if (!clientSecret) throw new Error('clientSecret missing from /create-payment');

      const { paymentIntent, error } = await stripe.confirmCardPayment(clientSecret, {
        payment_method: { card: cardElement }
      });

      if (error) {
        setStatus('Payment failed: ' + error.message, 'error');
        notarizeBtn.disabled = false;
        return;
      }
      if (!paymentIntent || paymentIntent.status !== 'succeeded') {
        setStatus('Payment did not complete.', 'error');
        notarizeBtn.disabled = false;
        return;
      }

      setStatus('Payment successful! Processing notarization...', 'success');
      await notarizeDocument();
    } catch (err) {
      console.error('Payment error:', err);
      setStatus('Payment process failed: ' + err.message, 'error');
      notarizeBtn.disabled = false;
    }
  });

  async function notarizeDocument() {
    const formData = new FormData();
    formData.append('document', uploadedFile);
    formData.append('name', uploadedFile.name);
    const { data: { user } } = await sb.auth.getUser();
    if (user?.email) formData.append('email', user.email);

    try {
      const response = await fetch(`${BACKEND_URL}/notarize`, { method: 'POST', body: formData });
      if (!response.ok) {
        const body = await response.text().catch(()=>'(no body)');
        throw new Error(`POST /notarize ${response.status} ${response.statusText}. Body: ${body}`);
      }
      const result = await response.json();
      if (!result.success) throw new Error(result.details || 'Unknown error');

      resultsSection.style.display = 'block';
      resultsInfoDiv.innerHTML = `
        <div class="status success">
          <p><strong>Notarization Complete!</strong></p>
          <p><strong>VeChain Transaction:</strong> <a href="${result.explorerUrl}" target="_blank">${result.vechainTx}</a></p>
          <p><strong>Document Hash:</strong> ${result.documentHash}</p>
          <p><strong>Document URL:</strong> <a href="${result.documentUrl}" target="_blank">View File</a></p>
        </div>
      `;
      setStatus('Notarization complete.', 'success');
    } catch (err) {
      console.error('Notarize error:', err);
      setStatus('Notarization failed: ' + err.message, 'error');
    }
  }

  async function initialize() {
    // Do not block the app on Stripe config; auth/upload can work first
    await checkAuth();
    setStatus('Ready.', 'info');
  }

  initialize();
</script>

